global:
  # SMTPé…ç½®
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${ALERT_EMAIL_FROM}'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # é»˜è®¤è§£æè¶…æ—¶
  resolve_timeout: 5m

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤åˆ†ç»„
  group_by: ['alertname', 'cluster', 'service']
  
  # åˆ†ç»„ç­‰å¾…æ—¶é—´
  group_wait: 10s
  
  # åˆ†ç»„é—´éš”æ—¶é—´
  group_interval: 10s
  
  # é‡å¤å‘Šè­¦é—´éš”
  repeat_interval: 1h
  
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: 'default'
  
  # å­è·¯ç”±é…ç½®
  routes:
    # ä¸¥é‡å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
      continue: true
    
    # AIæ¨¡å‹ç›¸å…³å‘Šè­¦
    - match_re:
        alertname: '.*AI.*|.*Model.*'
      receiver: 'ai-team'
      group_by: ['alertname', 'model']
      repeat_interval: 2h
    
    # åŸºç¡€è®¾æ–½å‘Šè­¦
    - match_re:
        alertname: '.*Memory.*|.*CPU.*|.*Redis.*'
      receiver: 'infrastructure-team'
      group_by: ['alertname', 'service']
      repeat_interval: 4h
    
    # ä¸šåŠ¡é€»è¾‘å‘Šè­¦
    - match_re:
        alertname: '.*Task.*|.*Tool.*|.*HTTP.*'
      receiver: 'backend-team'
      group_by: ['alertname', 'service']
      repeat_interval: 2h
    
    # EventBuså‘Šè­¦
    - match_re:
        alertname: '.*EventBus.*'
      receiver: 'eventbus-team'
      group_by: ['alertname', 'event_type']
      repeat_interval: 1h
    
    # å¥åº·æ£€æŸ¥å‘Šè­¦
    - match_re:
        alertname: '.*Health.*|.*Unhealthy.*'
      receiver: 'ops-team'
      group_wait: 30s
      repeat_interval: 15m

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡ä¸å¥åº·ï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'ServiceUnhealthy'
    target_match_re:
      alertname: '.*HTTP.*|.*Task.*|.*Tool.*'
    equal: ['service']
  
  # å¦‚æœæ•´ä½“é”™è¯¯ç‡é«˜ï¼ŒæŠ‘åˆ¶å•ä¸ªæœåŠ¡é”™è¯¯ç‡å‘Šè­¦
  - source_match:
      alertname: 'HighOverallErrorRate'
    target_match:
      alertname: 'HighHTTPErrorRate'
  
  # å¦‚æœAIæ¨¡å‹æ— å“åº”ï¼ŒæŠ‘åˆ¶ç›¸å…³æ€§èƒ½å‘Šè­¦
  - source_match:
      alertname: 'AIModelNotResponding'
    target_match_re:
      alertname: '.*AIModel.*'
    equal: ['model']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default'
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        subject: '[SuperAI] å‘Šè­¦é€šçŸ¥ - {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          æ ‡ç­¾ä¿¡æ¯:
          {{ range .Labels.SortedPairs }}
          - {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
          
          Grafanaä»ªè¡¨ç›˜: http://grafana:3000/d/superai-system-overview
        html: |
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>SuperAIå‘Šè­¦é€šçŸ¥</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .alert { border-left: 4px solid #f39c12; padding: 10px; margin: 10px 0; background-color: #fef9e7; }
                  .critical { border-left-color: #e74c3c; background-color: #fdf2f2; }
                  .warning { border-left-color: #f39c12; background-color: #fef9e7; }
                  .info { border-left-color: #3498db; background-color: #ebf3fd; }
                  .header { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; }
                  .label { background-color: #ecf0f1; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; }
                  .timestamp { color: #7f8c8d; font-size: 0.9em; }
                  .description { margin: 10px 0; line-height: 1.4; }
                  .footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #ecf0f1; color: #7f8c8d; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h2>ğŸš¨ SuperAIç³»ç»Ÿå‘Šè­¦é€šçŸ¥</h2>
                  <p class="timestamp">é€šçŸ¥æ—¶é—´: {{ now.Format "2006-01-02 15:04:05" }}</p>
              </div>
              
              {{ range .Alerts }}
              <div class="alert {{ .Labels.severity }}">
                  <h3>{{ .Annotations.summary }}</h3>
                  <div class="description">{{ .Annotations.description }}</div>
                  <div class="timestamp">å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}</div>
                  
                  <div style="margin-top: 10px;">
                      <strong>æ ‡ç­¾ä¿¡æ¯:</strong><br>
                      {{ range .Labels.SortedPairs }}
                      <span class="label">{{ .Name }}: {{ .Value }}</span>
                      {{ end }}
                  </div>
              </div>
              {{ end }}
              
              <div class="footer">
                  <p>ğŸ“Š <a href="http://grafana:3000/d/superai-system-overview">æŸ¥çœ‹ç³»ç»Ÿç›‘æ§é¢æ¿</a></p>
                  <p>ğŸ¤– <a href="http://grafana:3000/d/superai-ai-services">æŸ¥çœ‹AIæœåŠ¡ç›‘æ§é¢æ¿</a></p>
                  <p>âš™ï¸ <a href="http://prometheus:9090/alerts">æŸ¥çœ‹Prometheuså‘Šè­¦</a></p>
              </div>
          </body>
          </html>
    
    webhook_configs:
      - url: '${ALERT_WEBHOOK_URL}'
        send_resolved: true
        http_config:
          basic_auth:
            username: '${WEBHOOK_USERNAME}'
            password: '${WEBHOOK_PASSWORD}'
        title: 'SuperAIå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          çº§åˆ«: {{ .Labels.severity }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_ALERT_EMAIL}'
        subject: 'ğŸš¨ [CRITICAL] SuperAIä¸¥é‡å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          âš ï¸ æ£€æµ‹åˆ°ä¸¥é‡å‘Šè­¦ï¼Œéœ€è¦ç«‹å³å¤„ç†ï¼
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å½±å“æœåŠ¡: {{ .Labels.service | default "æœªçŸ¥" }}
          {{ end }}
          
          è¯·ç«‹å³ç™»å½•ç³»ç»Ÿæ£€æŸ¥å¹¶å¤„ç†æ­¤å‘Šè­¦ã€‚
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#critical-alerts'
        title: 'ğŸš¨ SuperAIä¸¥é‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          *å‘Šè­¦*: {{ .Annotations.summary }}
          *æè¿°*: {{ .Annotations.description }}
          *çº§åˆ«*: {{ .Labels.severity }}
          *æ—¶é—´*: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        send_resolved: true

  # AIå›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'ai-team'
    email_configs:
      - to: '${AI_TEAM_EMAIL}'
        subject: '[SuperAI-AI] AIæ¨¡å‹å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          AIæ¨¡å‹ç›¸å…³å‘Šè­¦é€šçŸ¥ï¼š
          
          {{ range .Alerts }}
          æ¨¡å‹åç§°: {{ .Labels.model | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # åŸºç¡€è®¾æ–½å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'infrastructure-team'
    email_configs:
      - to: '${INFRA_TEAM_EMAIL}'
        subject: '[SuperAI-INFRA] åŸºç¡€è®¾æ–½å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          åŸºç¡€è®¾æ–½ç›¸å…³å‘Šè­¦é€šçŸ¥ï¼š
          
          {{ range .Alerts }}
          æœåŠ¡åç§°: {{ .Labels.service | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # åç«¯å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'backend-team'
    email_configs:
      - to: '${BACKEND_TEAM_EMAIL}'
        subject: '[SuperAI-BACKEND] åç«¯æœåŠ¡å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          åç«¯æœåŠ¡ç›¸å…³å‘Šè­¦é€šçŸ¥ï¼š
          
          {{ range .Alerts }}
          æœåŠ¡åç§°: {{ .Labels.service | default "æœªçŸ¥" }}
          ä»»åŠ¡ç±»å‹: {{ .Labels.task_type | default "æœªçŸ¥" }}
          å·¥å…·åç§°: {{ .Labels.tool | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # EventBuså›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'eventbus-team'
    email_configs:
      - to: '${EVENTBUS_TEAM_EMAIL}'
        subject: '[SuperAI-EVENTBUS] EventBuså‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          EventBusç›¸å…³å‘Šè­¦é€šçŸ¥ï¼š
          
          {{ range .Alerts }}
          äº‹ä»¶ç±»å‹: {{ .Labels.event_type | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # è¿ç»´å›¢é˜Ÿæ¥æ”¶å™¨
  - name: 'ops-team'
    email_configs:
      - to: '${OPS_TEAM_EMAIL}'
        subject: '[SuperAI-OPS] è¿ç»´å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          è¿ç»´ç›¸å…³å‘Šè­¦é€šçŸ¥ï¼š
          
          {{ range .Alerts }}
          æœåŠ¡åç§°: {{ .Labels.service | default "æœªçŸ¥" }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    
    pagerduty_configs:
      - routing_key: '${PAGERDUTY_ROUTING_KEY}'
        description: 'SuperAIå¥åº·æ£€æŸ¥å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        severity: '{{ .CommonLabels.severity }}'
        details:
          service: '{{ .CommonLabels.service }}'
          alertname: '{{ .GroupLabels.alertname }}'
          description: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'